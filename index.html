<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <title>麻雀チェッカー</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html { -webkit-text-size-adjust: 100%; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      /* ▼ 100svh でブラウザUIの出入りに追随 */
      min-height: 100svh;
      padding: 20px;
      /* 下余白はJSでフッター高さに合わせて可変にする */
      touch-action: manipulation;
    }
    .container {
      max-width: 900px; margin: 0 auto; background: white;
      border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 30px; text-align: center;
    }
    .header h1 { font-size: 2em; margin-bottom: 14px; }
    .usage-box {
      margin: 0 auto; background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.35);
      border-radius: 10px; padding: 12px 16px; max-width: 660px;
      text-align: left;
    }
    .usage-title { font-weight: 700; font-size: 1rem; margin-bottom: 6px; }
    .usage-list { margin-left: 1.2em; }
    .usage-list li { font-size: 1rem; line-height: 1.6; margin: 2px 0; }

    .content { padding: 30px; }
    .tiles-section { margin-bottom: 10px; }
    .suit-group { margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
    .suit-title { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #333; display: flex; align-items: center; }
    .suit-icon { width: 30px; height: 30px; margin-right: 10px; border-radius: 5px; }
    .man-icon { background: #8B4513; } .pin-icon { background: #DC143C; } .sou-icon { background: #228B22; } .ji-icon { background: #4B0082; }
    .tiles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }

    .tile-button {
      display: flex; flex-direction: column; align-items: center; padding: 10px;
      background: white; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;
      transition: all 0.3s ease; position: relative; width: 100%; font-family: inherit;
      font-size: 16px;
    }
    .tile-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .tile-button.selected-1 { background: #e3f2fd; border-color: #2196f3; }
    .tile-button.selected-2 { background: #bbdefb; border-color: #1976d2; }
    .tile-button.selected-3 { background: #90caf9; border-color: #1565c0; }
    .tile-button.selected-4 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; }
    .tile-button:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
    .tile-display { font-size: 1.8em; font-weight: bold; margin-bottom: 5px; }
    .tile-display.jihai { font-size: 1.5em; }
    .tile-count {
      position: absolute; top: -5px; right: -5px; background: #ff6b6b; color: white;
      border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
      font-size: 1.1em; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .result-section { margin: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; min-height: 100px; }
    .result-title { font-size: 1.3em; font-weight: bold; margin-bottom: 15px; color: #333; }

    .waiting-tiles { display: grid; grid-template-columns: repeat(auto-fit, minmax(84px, 1fr)); gap: 10px; align-items: stretch; }
    .waiting-tile {
      display: block; text-align: center; padding: 12px 10px; background: white; border: 2px solid #667eea;
      border-radius: 8px; font-size: 1.1em; font-weight: 700; color: #667eea; line-height: 1.2; animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
    .no-waiting { color: #6c757d; font-style: italic; }

    /* ==== 固定フッター（白カード＋二段） ==== */
    .footer-controls {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 1000;
      padding: 10px 12px; padding-bottom: calc(10px + env(safe-area-inset-bottom));
      display: flex; justify-content: center;
      background: transparent;
      pointer-events: none; /* 下の空間をクリック可に */
    }
    .footer-card {
      pointer-events: auto;
      width: min(900px, 100%);
      background: rgba(255,255,255,0.96);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 16px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.18);
      padding: 10px;
    }
    .footer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "clear check"
        "counter counter";
      gap: 8px;
      align-items: stretch;
    }
    .btn { width: 100%; padding: 12px 10px; font-size: 16px; border: none; border-radius: 12px; cursor: pointer; font-weight: 800; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; grid-area: check; }
    .btn-secondary { background: #6c757d; color: white; grid-area: clear; }
    .selected-chip {
      grid-area: counter; justify-self: center;
      background: #e9ecef; padding: 10px 14px; border-radius: 999px; font-size: 14px; font-weight: 800; white-space: nowrap;
    }

    .btn-lines { display: inline-block; line-height: 1.1; }
    .btn-lines .l2 { margin-left: .3em; }
    @media (max-width: 420px) {
      .btn-lines { display: block; }
      .btn-lines .l1, .btn-lines .l2 { display: block; }
      .btn-lines .l2 { margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🀄 麻雀チェッカー</h1>
      <div class="usage-box">
        <div class="usage-title">使い方</div>
        <ul class="usage-list">
          <li>自分の持つ牌をクリック</li>
          <li>最大4枚クリック可（4→0に戻る）</li>
          <li>「待ち牌を調べる」をクリック</li>
        </ul>
      </div>
    </div>

    <div class="content">
      <div class="tiles-section">
        <div class="suit-group">
          <div class="suit-title"><div class="suit-icon man-icon"></div>萬子（マンズ）</div>
          <div class="tiles-grid" id="man-tiles"></div>
        </div>
        <div class="suit-group">
          <div class="suit-title"><div class="suit-icon pin-icon"></div>筒子（ピンズ）</div>
          <div class="tiles-grid" id="pin-tiles"></div>
        </div>
        <div class="suit-group">
          <div class="suit-title"><div class="suit-icon sou-icon"></div>索子（ソーズ）</div>
          <div class="tiles-grid" id="sou-tiles"></div>
        </div>
        <div class="suit-group">
          <div class="suit-title"><div class="suit-icon ji-icon"></div>字牌（ジハイ）</div>
          <div class="tiles-grid" id="ji-tiles"></div>
        </div>
      </div>

      <div id="limitMsg" class="no-waiting" style="margin:0 20px 10px; display:none;">13枚までです。新しい牌は選択できません。</div>

      <div id="result-section" class="result-section">
        <div class="result-title">待ち牌</div>
        <div id="result"><p class="no-waiting">13枚の牌を選択してください</p></div>
      </div>
    </div>
  </div>

  <!-- 固定フッター -->
  <div class="footer-controls" role="toolbar" aria-label="操作">
    <div id="footerCard" class="footer-card">
      <div class="footer-grid">
        <button class="btn btn-secondary" id="clearBtn">
          <span class="btn-lines"><span class="l1">選択を</span><span class="l2">クリア</span></span>
        </button>
        <button class="btn btn-primary" id="checkBtn" disabled>
          <span class="btn-lines"><span class="l1">待ち牌を</span><span class="l2">調べる</span></span>
        </button>
        <div class="selected-chip">選択中: <span id="selectedCount">0</span> / 13枚</div>
      </div>
    </div>
  </div>

<script>
  const MAX_SELECTED = 13;

  const tiles = {
    man: [1,9],
    pin: [1,2,3,4,5,6,7,8,9],
    sou: [1,2,3,4,5,6,7,8,9],
    ji: ['東','南','西','北','白','發','中']
  };

  const tileCount = {};
  let selectedTotal = 0;

  function init() {
    const manContainer = document.getElementById('man-tiles');
    tiles.man.forEach(num => {
      const tileId = `m${num}`;
      tileCount[tileId] = 0;
      manContainer.innerHTML += createTileHTML('m', num);
    });

    const pinContainer = document.getElementById('pin-tiles');
    tiles.pin.forEach(num => {
      const tileId = `p${num}`;
      tileCount[tileId] = 0;
      pinContainer.innerHTML += createTileHTML('p', num);
    });

    const souContainer = document.getElementById('sou-tiles');
    tiles.sou.forEach(num => {
      const tileId = `s${num}`;
      tileCount[tileId] = 0;
      souContainer.innerHTML += createTileHTML('s', num);
    });

    const jiContainer = document.getElementById('ji-tiles');
    tiles.ji.forEach((char, index) => {
      const tileId = `z${index + 1}`;
      tileCount[tileId] = 0;
      jiContainer.innerHTML += createJihaiHTML(index + 1, char);
    });

    document.getElementById('checkBtn').addEventListener('click', () => {
      checkWaiting();
      requestAnimationFrame(() => {
        document.getElementById('result-section').scrollIntoView({behavior:'smooth', block:'start'});
      });
    });
    document.getElementById('clearBtn').addEventListener('click', clearSelection);

    // ▼ フッター高さに合わせてbody下余白を動的設定（Safariのバー出入りに追随）
    const applyFooterSpace = () => {
      const card = document.getElementById('footerCard');
      if (!card) return;
      const h = Math.ceil(card.getBoundingClientRect().height);
      // 余白+8pxで少し余裕
      document.body.style.paddingBottom = (h + 8) + 'px';
    };
    applyFooterSpace();

    // visualViewport があればそれに追随
    if (window.visualViewport) {
      visualViewport.addEventListener('resize', applyFooterSpace);
      visualViewport.addEventListener('scroll', applyFooterSpace);
    }
    window.addEventListener('resize', applyFooterSpace);
    window.addEventListener('orientationchange', applyFooterSpace);
  }

  function createTileHTML(suit, num) {
    const tileId = `${suit}${num}`;
    const suitName = suit === 'm' ? '萬' : suit === 'p' ? '筒' : '索';
    return `
      <button id="${tileId}" class="tile-button" onclick="updateTileSelection('${tileId}')" type="button">
        <span class="tile-display">${num}</span>
        <span style="font-size: 0.8em">${suitName}</span>
        <span class="tile-count" id="count-${tileId}" style="display: none;">0</span>
      </button>
    `;
  }

  function createJihaiHTML(num, char) {
    const tileId = `z${num}`;
    return `
      <button id="${tileId}" class="tile-button" onclick="updateTileSelection('${tileId}')" type="button">
        <span class="tile-display jihai">${char}</span>
        <span class="tile-count" id="count-${tileId}" style="display: none;">0</span>
      </button>
    `;
  }

  // 13枚制限（強化版）
  function updateTileSelection(tileId) {
    const current = tileCount[tileId];

    if (selectedTotal >= MAX_SELECTED) {
      if (current === 0) { flashLimit(); return; }
      applyCount(tileId, 0);
      return;
    }

    const next = (current >= 4) ? 0 : current + 1;
    const delta = next - current;

    if (selectedTotal + delta > MAX_SELECTED) {
      if (current === 0) { flashLimit(); return; }
      applyCount(tileId, 0);
      return;
    }

    applyCount(tileId, next);
  }

  function applyCount(tileId, newCount) {
    const button = document.getElementById(tileId);
    const countSpan = document.getElementById(`count-${tileId}`);
    const old = tileCount[tileId];
    tileCount[tileId] = newCount;
    selectedTotal += (newCount - old);

    button.className = 'tile-button';
    if (newCount > 0) {
      button.classList.add(`selected-${newCount}`);
      countSpan.textContent = newCount;
      countSpan.style.display = 'flex';
    } else {
      countSpan.style.display = 'none';
    }
    hideLimit();
    updateUI();
  }

  function updateUI() {
    document.getElementById('selectedCount').textContent = selectedTotal;
    document.getElementById('checkBtn').disabled = (selectedTotal !== MAX_SELECTED);

    Object.keys(tileCount).forEach(tileId => {
      const button = document.getElementById(tileId);
      const current = tileCount[tileId];
      button.disabled = (selectedTotal >= MAX_SELECTED && current === 0);
    });
  }

  function clearSelection() {
    Object.keys(tileCount).forEach(tileId => {
      tileCount[tileId] = 0;
      const button = document.getElementById(tileId);
      button.className = 'tile-button';
      button.disabled = false;
      document.getElementById(`count-${tileId}`).style.display = 'none';
    });
    selectedTotal = 0;
    hideLimit();
    updateUI();
    document.getElementById('result').innerHTML = '<p class="no-waiting">13枚の牌を選択してください</p>';
  }

  function flashLimit() {
    const el = document.getElementById('limitMsg');
    el.style.display = 'block';
    clearTimeout(flashLimit._t);
    flashLimit._t = setTimeout(() => { el.style.display = 'none'; }, 1500);
  }
  function hideLimit() { document.getElementById('limitMsg').style.display = 'none'; }

  function checkWaiting() {
    const hand = [];
    Object.keys(tileCount).forEach(tileId => {
      for (let i = 0; i < tileCount[tileId]; i++) hand.push(tileId);
    });
    const waitingTiles = findWaitingTiles(hand);
    displayResult(waitingTiles);
  }

  function findWaitingTiles(hand) {
    const waiting = [];
    const allTiles = [];
    tiles.man.forEach(n => allTiles.push(`m${n}`));
    tiles.pin.forEach(n => allTiles.push(`p${n}`));
    tiles.sou.forEach(n => allTiles.push(`s${n}`));
    tiles.ji.forEach((_, i) => allTiles.push(`z${i + 1}`));

    const kokushi13 = checkKokushi13Wait(hand);
    if (kokushi13.length > 0) return kokushi13;

    for (const tile of allTiles) {
      const currentCount = hand.filter(t => t === tile).length;
      if (currentCount >= 4) continue;
      const testHand = [...hand, tile].sort();
      if (isWinningHand(testHand)) waiting.push(tile);
    }
    return waiting;
  }

  function checkKokushi13Wait(hand) {
    const yaochuuTiles = ['m1','m9','p1','p9','s1','s9','z1','z2','z3','z4','z5','z6','z7'];
    if (hand.length !== 13) return [];
    const counts = {};
    hand.forEach(tile => counts[tile] = (counts[tile] || 0) + 1);
    for (const tile of hand) if (!yaochuuTiles.includes(tile)) return [];
    let allSingle = true;
    for (const tile of yaochuuTiles) {
      const c = counts[tile] || 0;
      if (c !== 1) { allSingle = false; break; }
    }
    if (allSingle) return yaochuuTiles;
    return [];
  }

  function isWinningHand(hand) {
    const counts = {};
    hand.forEach(tile => counts[tile] = (counts[tile] || 0) + 1);
    if (isKokushimusou(counts)) return true;
    if (isChitoitsu(counts)) return true;
    return checkNormalWin(counts);
  }

  function isKokushimusou(counts) {
    const yaochuuTiles = ['m1','m9','p1','p9','s1','s9','z1','z2','z3','z4','z5','z6','z7'];
    let pairCount = 0, singleCount = 0;
    for (const tile of yaochuuTiles) {
      const c = counts[tile] || 0;
      if (c === 0) return false;
      else if (c === 1) singleCount++;
      else if (c === 2) pairCount++;
      else return false;
    }
    for (const [tile, c] of Object.entries(counts)) {
      if (!yaochuuTiles.includes(tile) && c > 0) return false;
    }
    return pairCount === 1 && singleCount === 12;
  }

  function isChitoitsu(counts) {
    const pairs = Object.values(counts).filter(c => c === 2).length;
    return pairs === 7;
  }

  function checkNormalWin(counts) {
    for (const [tile, c] of Object.entries(counts)) {
      if (c >= 2) {
        const t = {...counts}; t[tile] -= 2;
        if (checkMentsu(t)) return true;
      }
    }
    return false;
  }

  function checkMentsu(counts) {
    const tilesArr = [];
    for (const [tile, c] of Object.entries(counts)) {
      for (let i = 0; i < c; i++) tilesArr.push(tile);
    }
    if (tilesArr.length === 0) return true;
    return removeMentsu(counts);
  }

  function removeMentsu(counts) {
    const total = Object.values(counts).reduce((s, c) => s + c, 0);
    if (total === 0) return true;
    const tilesArr = Object.keys(counts).filter(t => counts[t] > 0).sort();
    if (tilesArr.length === 0) return true;
    const first = tilesArr[0];

    if (counts[first] >= 3) {
      const n = {...counts}; n[first] -= 3;
      if (removeMentsu(n)) return true;
    }

    const suit = first[0];
    if (suit !== 'z') {
      const num = parseInt(first.substring(1));
      const next1 = `${suit}${num + 1}`;
      const next2 = `${suit}${num + 2}`;
      if ((counts[first]||0)>=1 && (counts[next1]||0)>=1 && (counts[next2]||0)>=1) {
        const n = {...counts};
        n[first]--; n[next1]--; n[next2]--;
        if (removeMentsu(n)) return true;
      }
    }
    return false;
  }

  function displayResult(waitingTiles) {
    const resultDiv = document.getElementById('result');
    if (!waitingTiles || waitingTiles.length === 0) {
      resultDiv.innerHTML = '<p class="no-waiting">待ち牌はありません（または未成立）</p>';
      return;
    }
    const html = `<div class="waiting-tiles">` + waitingTiles.map(t => {
      const suit = t[0];
      const num = t.substring(1);
      const label =
        suit === 'm' ? `${num}萬` :
        suit === 'p' ? `${num}筒` :
        suit === 's' ? `${num}索` :
        ['東','南','西','北','白','發','中'][parseInt(num)-1];
      return `<span class="waiting-tile">${label}</span>`;
    }).join('') + `</div>`;
    resultDiv.innerHTML = html;
  }

  init();
</script>
</body>
</html>
